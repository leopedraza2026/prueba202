<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minimercado - Admin Control</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
            --accent-color: #f59e0b;
            --bg-color: #f3f4f6;
            --text-color: #1f2937;
            --card-bg: #ffffff;
            --danger-color: #ef4444;
            --success-color: #10b981;
            --warning-color: #d97706;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-color); min-height: 100vh; display: flex; flex-direction: column; }

        .hidden { display: none !important; }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.3s; font-size: 0.9rem; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--secondary-color); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-warning { background-color: var(--accent-color); color: white; }
        .btn-warning:hover { background-color: var(--warning-color); }
        .w-100 { width: 100%; }
        .mt-2 { margin-top: 1rem; }
        .mb-2 { margin-bottom: 1rem; }
        .text-center { text-align: center; }
        
        .qty-btn { 
            width: 28px; height: 28px; border-radius: 50%; border: none; 
            cursor: pointer; font-weight: bold; display: inline-flex; 
            justify-content: center; align-items: center; color: white;
        }
        .qty-btn:hover { opacity: 0.8; }
        .qty-minus { background-color: var(--danger-color); }
        .qty-plus { background-color: var(--success-color); }

        #login-view { display: flex; justify-content: center; align-items: center; height: 100vh; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); }
        .login-card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 100%; max-width: 400px; }
        .login-card h2 { margin-bottom: 1.5rem; text-align: center; color: var(--secondary-color); font-size: 1.5rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-control { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem; }

        header { background-color: white; padding: 1rem 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .user-info span { font-weight: bold; color: var(--primary-color); }
        main { padding: 2rem; max-width: 1400px; margin: 0 auto; width: 100%; }

        .tabs { display: flex; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb; }
        .tab-btn { padding: 12px 24px; cursor: pointer; background: none; border: none; font-size: 1rem; color: #666; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); font-weight: bold; }

        .admin-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 2rem; }
        @media(max-width: 900px) { .admin-grid { grid-template-columns: 1fr; } }
        .card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .card h3 { margin-bottom: 1rem; border-bottom: 2px solid var(--bg-color); padding-bottom: 0.5rem; }
        .inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem; }
        .product-card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 10px; background: #fafafa; text-align: center; display: flex; flex-direction: column; }
        .product-img { width: 100%; height: 150px; object-fit: cover; border-radius: 4px; margin-bottom: 0.5rem; background-color: #ddd; }
        .sector-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; background-color: var(--accent-color); color: white; margin-bottom: 0.5rem; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 5px solid var(--primary-color); }
        .stat-card h4 { color: #666; font-size: 0.9rem; margin-bottom: 0.5rem; }
        .stat-card .value { font-size: 1.5rem; font-weight: bold; color: var(--text-color); }
        .stat-card.success { border-left-color: var(--success-color); }

        .history-table { width: 100%; border-collapse: collapse; margin-top: 1rem; background: white; }
        .history-table th, .history-table td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        .history-table th { background-color: #f9fafb; font-weight: 600; }

        .pos-container { display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; height: calc(100vh - 150px); }
        @media(max-width: 900px) { .pos-container { grid-template-columns: 1fr; height: auto; } .cart-panel { position: static; height: auto; } }
        .products-panel { overflow-y: auto; padding-right: 10px; }
        .cart-panel { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 -4px 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; height: 100%; }
        .cart-items { flex-grow: 1; overflow-y: auto; margin: 1rem 0; border-top: 1px solid #eee; border-bottom: 1px solid #eee; }
        
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem 0; border-bottom: 1px dashed #eee; }
        .cart-total { font-size: 1.5rem; font-weight: bold; color: var(--primary-color); margin: 1rem 0; display: flex; justify-content: space-between; }
        .change-display { background-color: var(--success-color); color: white; padding: 1rem; border-radius: 6px; text-align: center; font-size: 1.2rem; margin-top: 1rem; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 8px; width: 90%; max-width: 500px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .close-modal { float: right; cursor: pointer; font-size: 1.5rem; font-weight: bold; }

        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 2000; left: 50%; bottom: 30px; transform: translateX(-50%); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

    <!-- FIREBASE SDKS (VERSION 10) -->
    <script type="module">
        // Importaciones modulares de Firebase v10
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            updatePassword 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            doc, 
            onSnapshot, 
            query, 
            orderBy,
            where,
            setDoc,
            getDoc 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CONFIGURACI√ìN FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBRdH-u79KSCaWqMQ7a15aB_Vrx90qfdAA",
            authDomain: "paginaweb-a065b.firebaseapp.com",
            projectId: "paginaweb-a065b",
            storageBucket: "paginaweb-a065b.firebasestorage.app",
            messagingSenderId: "733342044929",
            appId: "1:733342044929:web:e511a68a1e0be15c618100",
            measurementId: "G-CQGXH3SFHE"
        };

        // Inicializar Servicios
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- VARIABLES GLOBALES ---
        let currentUser = null;
        let currentUserRole = null;
        let cart = [];
        let productsArray = [];
        let salesArray = [];
        let usersArray = [];

        // --- ESCUCHAS EN TIEMPO REAL ---
        function initRealtimeListeners() {
            const productsQuery = query(collection(db, "products"));
            onSnapshot(productsQuery, (snapshot) => {
                productsArray = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (!document.getElementById('admin-inventory-view').classList.contains('hidden')) renderAdminInventory();
                if (!document.getElementById('seller-panel').classList.contains('hidden')) renderSellerProducts();
            });

            const salesQuery = query(collection(db, "sales"), orderBy("date", "desc"));
            onSnapshot(salesQuery, (snapshot) => {
                salesArray = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (!document.getElementById('admin-reports-view').classList.contains('hidden')) renderAdminStats();
                if (!document.getElementById('seller-history-view').classList.contains('hidden')) renderSellerHistory();
            });

            onSnapshot(collection(db, "users"), (snapshot) => {
                usersArray = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (!document.getElementById('admin-users-view').classList.contains('hidden')) renderUserManagement();
            });
        }
        initRealtimeListeners();

        // Exponer funciones al objeto window
        window.addToCart = addToCart;
        window.changeQty = changeQty;
        window.processSale = processSale;
        window.clearCart = clearCart;
        window.calculateChange = calculateChange;
        window.handleLogout = handleLogout;
        // toggleRegisterMode eliminado
        // handleRegister eliminado
        window.switchAdminTab = switchAdminTab;
        window.switchSellerTab = switchSellerTab;
        window.addProduct = addProduct;
        window.deleteProduct = deleteProduct;
        window.openEditModal = openEditModal;
        window.saveProductChanges = saveProductChanges;
        window.adjustStock = adjustStock;
        window.createUser = createUser;
        window.deleteUserFirestore = deleteUserFirestore;
        window.updateSelfPassword = updateSelfPassword;
        window.filterSellerProducts = filterSellerProducts;
        window.openCashClose = openCashClose;
        window.closeModal = closeModal;
        window.confirmCashClose = confirmCashClose;
        window.confirmClearReport = confirmClearReport;

        // --- AUTENTICACI√ìN ---

        onAuthStateChanged(async (user) => {
            const loginView = document.getElementById('login-view');
            const mainApp = document.getElementById('main-app');

            if (user) {
                currentUser = user;
                document.getElementById('user-display').textContent = user.email;

                try {
                    const userDoc = await getDoc(doc(db, 'users', user.uid));
                    if (userDoc.exists()) {
                        currentUserRole = userDoc.data().role;
                    } else {
                        currentUserRole = 'vendedor';
                    }
                } catch (error) {
                    console.error(error);
                    currentUserRole = 'vendedor';
                }

                loginView.classList.add('hidden');
                mainApp.classList.remove('hidden');

                if (currentUserRole === 'admin') {
                    document.getElementById('admin-panel').classList.remove('hidden');
                    renderAdminInventory();
                    renderAdminStats();
                    renderUserManagement();
                } else {
                    document.getElementById('seller-panel').classList.remove('hidden');
                    renderSellerProducts();
                    renderSellerHistory();
                }

            } else {
                currentUser = null;
                currentUserRole = null;
                loginView.classList.remove('hidden');
                mainApp.classList.add('hidden');
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                showToast("‚ùå Error: " + error.message);
            }
        });

        // Funciones de Registro P√∫blico eliminadas

        function handleLogout() {
            signOut(auth);
        }

        // --- ADMINISTRADOR ---

        function switchAdminTab(tab) {
            document.querySelectorAll('#admin-panel .tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            ['admin-inventory-view', 'admin-reports-view', 'admin-users-view'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(`admin-${tab}-view`).classList.remove('hidden');
            
            if(tab === 'inventory') renderAdminInventory();
            if(tab === 'reports') renderAdminStats();
            if(tab === 'users') renderUserManagement();
        }

        async function addProduct(e) {
            e.preventDefault();
            const name = document.getElementById('prod-name').value;
            const price = parseFloat(document.getElementById('prod-price').value);
            const stock = parseInt(document.getElementById('prod-stock').value);
            const sector = document.getElementById('prod-sector').value;
            const fileInput = document.getElementById('prod-image');
            const defaultImg = `https://picsum.photos/seed/${Date.now()}/200/200.jpg`;
            
            const process = async (img) => {
                try {
                    await addDoc(collection(db, "products"), {
                        name, price, stock, sector, image: img, createdAt: new Date().toISOString()
                    });
                    showToast("‚úÖ Producto agregado");
                    document.getElementById('add-product-form').reset();
                } catch (error) {
                    showToast("‚ùå Error guardando: " + error.message);
                }
            };

            if (fileInput.files[0]) {
                const reader = new FileReader();
                reader.readAsDataURL(fileInput.files[0]);
                reader.onload = (evt) => {
                    const img = new Image(); img.src = evt.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX = 400; let w = img.width, h = img.height;
                        if (w > h) { if (w > MAX) { h *= MAX / w; w = MAX; } } else { if (h > MAX) { w *= MAX / h; h = MAX; } }
                        canvas.width = w; canvas.height = h; ctx.drawImage(img, 0, 0, w, h);
                        process(canvas.toDataURL('image/jpeg', 0.7));
                    }
                }
            } else { process(defaultImg); }
        }

        async function deleteProduct(id) {
            if(confirm("¬øEliminar?")) {
                try {
                    await deleteDoc(doc(db, "products", id));
                    showToast("üóëÔ∏è Eliminado");
                } catch(e) { showToast("Error: "+e.message); }
            }
        }

        function openEditModal(id) {
            const p = productsArray.find(x => x.id === id); if(!p) return;
            document.getElementById('edit-id').value = p.id;
            document.getElementById('edit-name').value = p.name;
            document.getElementById('edit-price').value = p.price;
            document.getElementById('edit-sector').value = p.sector;
            document.getElementById('edit-product-modal').style.display = 'flex';
        }

        async function saveProductChanges(e) {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const name = document.getElementById('edit-name').value;
            const price = parseFloat(document.getElementById('edit-price').value);
            const sector = document.getElementById('edit-sector').value;
            try {
                await updateDoc(doc(db, "products", id), { name, price, sector });
                closeModal('edit-product-modal');
                showToast("‚úÖ Actualizado");
            } catch(e) { showToast("Error: "+e.message); }
        }

        async function adjustStock(id, change) {
            const p = productsArray.find(x => x.id === id); if(!p) return;
            const newStock = p.stock + change;
            if (newStock < 0) return showToast("‚ö†Ô∏è Stock negativo");
            try {
                await updateDoc(doc(db, "products", id), { stock: newStock });
            } catch(e) { showToast("Error: "+e.message); }
        }

        function renderAdminInventory() {
            const container = document.getElementById('admin-inventory-list');
            const search = document.getElementById('search-inventory').value.toLowerCase();
            container.innerHTML = '';
            
            productsArray
                .filter(p => p.name.toLowerCase().includes(search))
                .forEach(p => {
                container.innerHTML += `
                    <div class="product-card">
                        <img src="${p.image}" class="product-img">
                        <span class="sector-badge">S${p.sector}</span>
                        <h4>${p.name}</h4>
                        <p style="font-weight:bold; color:var(--primary-color)">bs ${p.price}</p>
                        <div style="display:flex; justify-content:center; gap:8px; margin:10px 0;">
                            <button class="qty-btn qty-minus" onclick="adjustStock('${p.id}', -1)">-</button>
                            <span style="font-weight:bold">${p.stock}</span>
                            <button class="qty-btn qty-plus" onclick="adjustStock('${p.id}', 1)">+</button>
                        </div>
                        <div style="display:flex; gap:5px;">
                            <button class="btn btn-warning w-100" style="font-size:0.8rem" onclick="openEditModal('${p.id}')">‚úèÔ∏è</button>
                            <button class="btn btn-danger w-100" style="font-size:0.8rem" onclick="deleteProduct('${p.id}')">üóëÔ∏è</button>
                        </div>
                    </div>`;
            });
            document.getElementById('total-items-badge').textContent = `${productsArray.length} items`;
        }

        function renderAdminStats() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
            const weekAgo = new Date(now.setDate(now.getDate() - 7)).toISOString();
            
            let sT=0, sW=0;
            const tbody = document.getElementById('full-sales-table'); tbody.innerHTML = '';
            
            salesArray.forEach(sale => {
                if (sale.date >= today) sT += sale.total;
                if (sale.date >= weekAgo) sW += sale.total;
                tbody.innerHTML += `<tr><td>${new Date(sale.date).toLocaleString()}</td><td>${sale.seller}</td><td style="font-weight:bold; color:var(--success-color)">bs ${sale.total}</td></tr>`;
            });
            document.getElementById('stat-today').textContent = `bs ${sT.toLocaleString()}`;
            document.getElementById('stat-week').textContent = `bs ${sW.toLocaleString()}`;
            document.getElementById('stat-month').textContent = `bs ${sW.toLocaleString()}`;
        }

        function renderUserManagement() {
            const tbody = document.getElementById('users-table-body'); tbody.innerHTML = '';
            usersArray.forEach(u => {
                const isSelf = currentUser && currentUser.uid === u.id;
                const roleBadge = u.role === 'admin' 
                    ? '<span class="sector-badge" style="background:var(--primary-color)">Admin</span>' 
                    : '<span class="sector-badge" style="background:var(--accent-color)">Vendedor</span>';
                
                tbody.innerHTML += `
                    <tr>
                        <td>${u.email} ${isSelf ? '(T√∫)' : ''}</td>
                        <td>${roleBadge}</td>
                        <td>${!isSelf ? `<button class="btn btn-danger" style="padding:4px 8px; font-size:0.8rem;" onclick="deleteUserFirestore('${u.id}')">Eliminar</button>` : ''}</td>
                    </tr>`;
            });
        }

        // FUNCI√ìN PARA CREAR USUARIO (Solo desde Admin)
        async function createUser(e) {
            e.preventDefault();
            const email = document.getElementById('new-username').value;
            const pass = document.getElementById('new-userpass').value;
            const role = document.getElementById('new-userrole').value;
            try {
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                await setDoc(doc(db, 'users', cred.user.uid), { email, role, createdAt: new Date().toISOString() });
                showToast("‚úÖ Usuario creado");
                document.getElementById('add-user-form').reset();
            } catch(error) {
                showToast("‚ùå Error: " + error.message);
            }
        }

        function deleteUserFirestore(uid) {
            if(confirm("¬øEliminar acceso de este usuario?")) {
                deleteDoc(doc(db, "users", uid)).then(()=>showToast("Eliminado")).catch(e=>showToast(e.message));
            }
        }

        function updateSelfPassword() {
            const newPass = document.getElementById('new-password-self').value;
            if(newPass.length < 6) return showToast("M√≠nimo 6 caracteres");
            updatePassword(currentUser, newPass).then(()=>showToast("‚úÖ Actualizada")).catch(e=>showToast(e.message));
        }

        // --- VENDEDOR ---

        function switchSellerTab(tab) {
            document.querySelectorAll('#seller-panel .tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            if(tab==='pos') { 
                document.getElementById('seller-pos-view').classList.remove('hidden'); 
                document.getElementById('seller-history-view').classList.add('hidden'); 
            } else { 
                document.getElementById('seller-pos-view').classList.add('hidden'); 
                document.getElementById('seller-history-view').classList.remove('hidden'); 
                renderSellerHistory(); 
            }
        }

        let currentFilter = 'all';
        function filterSellerProducts(sec) { currentFilter = sec; renderSellerProducts(); }

        function renderSellerProducts() {
            const container = document.getElementById('seller-products-grid');
            const search = document.getElementById('seller-search').value.toLowerCase();
            container.innerHTML = '';
            const filtered = productsArray.filter(p => 
                p.name.toLowerCase().includes(search) && 
                (currentFilter === 'all' || p.sector === currentFilter) && 
                p.stock > 0
            );
            filtered.forEach(p => {
                container.innerHTML += `
                    <div class="product-card" onclick="addToCart('${p.id}')" style="cursor:pointer;">
                        <img src="${p.image}" class="product-img">
                        <span class="sector-badge">S${p.sector}</span>
                        <h4>${p.name}</h4>
                        <p>Disp: ${p.stock}</p>
                        <p style="font-weight:bold; color:var(--primary-color)">bs ${p.price}</p>
                        <button class="btn btn-primary mt-2">Agregar</button>
                    </div>`;
            });
        }

        function addToCart(id) {
            const p = productsArray.find(x => x.id === id);
            const inCart = cart.find(x => x.id === id);
            const currentQty = inCart ? inCart.qty : 0;
            if (currentQty >= p.stock) return showToast("‚ö†Ô∏è Stock m√°ximo");
            if(inCart) inCart.qty++; else cart.push({...p, qty: 1});
            renderCart();
        }

        function changeQty(id, change) {
            const item = cart.find(x => x.id === id); if(!item) return;
            const p = productsArray.find(x => x.id === id);
            item.qty += change;
            if (item.qty <= 0) cart = cart.filter(x => x.id !== id);
            else if (item.qty > p.stock) { item.qty = p.stock; showToast("‚ö†Ô∏è Sin stock"); }
            renderCart();
        }

        function renderCart() {
            const container = document.getElementById('cart-items-container'); container.innerHTML = ''; let total = 0;
            if (cart.length === 0) {
                container.innerHTML = '<p class="text-center" style="margin-top:20px; color:#999">Vac√≠o</p>';
                document.getElementById('cart-total-amount').textContent = 'bs 0.00';
                document.getElementById('change-result').classList.add('hidden');
                return;
            }
            cart.forEach(item => {
                total += item.price * item.qty;
                container.innerHTML += `
                    <div class="cart-item">
                        <div style="flex-grow:1"><strong>${item.name}</strong><div style="font-size:0.9rem; color:#666">bs ${item.price} c/u</div></div>
                        <div class="qty-control"><button class="qty-btn" style="background:#ddd; color:#333;" onclick="changeQty('${item.id}', -1)">-</button><span style="font-weight:bold; width:20px; text-align:center;">${item.qty}</span><button class="qty-btn" style="background:#ddd; color:#333;" onclick="changeQty('${item.id}', 1)">+</button></div>
                        <div style="font-weight:bold; margin-left:10px; min-width:60px; text-align:right">bs ${(item.price * item.qty).toLocaleString()}</div>
                    </div>`;
            });
            document.getElementById('cart-total-amount').textContent = `bs ${total.toLocaleString()}`;
            calculateChange();
        }

        function calculateChange() {
            const total = cart.reduce((s,i) => s+(i.price*i.qty), 0);
            const given = parseFloat(document.getElementById('cash-given').value) || 0;
            const resDiv = document.getElementById('change-result');
            if (given > 0) {
                const change = given - total;
                document.getElementById('change-amount').textContent = `bs ${change.toLocaleString()}`;
                resDiv.classList.remove('hidden');
                resDiv.querySelector('.change-display').style.backgroundColor = change >= 0 ? 'var(--success-color)' : 'var(--danger-color)';
            } else { resDiv.classList.add('hidden'); }
        }

        async function processSale() {
            if (cart.length === 0) return showToast("‚ö†Ô∏è Vac√≠o");
            const total = cart.reduce((s,i) => s+(i.price*i.qty), 0);
            const given = parseFloat(document.getElementById('cash-given').value) || 0;
            if (given < total) return showToast("‚ùå Dinero insuficiente");
            
            try {
                await addDoc(collection(db, "sales"), {
                    date: new Date().toISOString(),
                    seller: currentUser.email,
                    total: total,
                    items: [...cart],
                    cleared: false
                });

                const batchUpdate = async () => {
                    cart.forEach(async (c) => {
                        const pRef = doc(db, "products", c.id);
                        const pSnap = await getDoc(pRef);
                        if(pSnap.exists()) {
                            const currentStock = pSnap.data().stock;
                            await updateDoc(pRef, { stock: currentStock - c.qty });
                        }
                    });
                };
                await batchUpdate();

                showToast("‚úÖ Venta Exitosa");
                clearCart();
                renderSellerProducts();
            } catch(e) {
                showToast("‚ùå Error: " + e.message);
            }
        }

        function clearCart() { cart = []; renderCart(); document.getElementById('cash-given').value = ''; }

        function renderSellerHistory() {
            const today = new Date().toDateString();
            const container = document.getElementById('today-sales-table');
            container.innerHTML = '';
            const todaySales = salesArray.filter(s => 
                new Date(s.date).toDateString() === today && 
                s.seller === currentUser.email && 
                !s.cleared
            );
            if (todaySales.length === 0) { container.innerHTML = '<tr><td colspan="3" class="text-center">Sin ventas hoy</td></tr>'; return; }
            let total = 0;
            todaySales.forEach(s => {
                total += s.total;
                container.innerHTML += `<tr><td>${new Date(s.date).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</td><td>${s.items.map(i=>`${i.qty}x ${i.name}`).join(', ')}</td><td style="font-weight:bold">bs ${s.total.toLocaleString()}</td></tr>`;
            });
            container.innerHTML += `<tr style="background:#f0fdf4; font-weight:bold; border-top:2px solid var(--success-color);"><td colspan="2" class="text-right">Total D√≠a:</td><td>bs ${total.toLocaleString()}</td></tr>`;
        }

        function openCashClose() {
            const today = new Date().toDateString();
            const todaySales = salesArray.filter(s => new Date(s.date).toDateString() === today && s.seller === currentUser.email && !s.cleared);
            const total = todaySales.reduce((sum,s)=>sum+s.total,0);
            document.getElementById('cash-close-total').textContent = `bs ${total.toLocaleString()}`;
            document.getElementById('cash-close-count').textContent = `${todaySales.length} ventas`;
            document.getElementById('cash-close-modal').style.display = 'flex';
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        async function confirmCashClose() {
            const today = new Date().toDateString();
            const batch = db.batch();
            salesArray.forEach(s => {
                if(new Date(s.date).toDateString() === today && s.seller === currentUser.email) {
                    const ref = doc(db, "sales", s.id);
                    batch.update(ref, { cleared: true });
                }
            });
            await batch.commit();
            closeModal('cash-close-modal');
            showToast("üßæ Cierre realizado");
        }
        
        async function confirmClearReport(type) {
             showToast("Funci√≥n en desarrollo");
        }

        window.showToast = function(msg) {
            const t = document.getElementById("toast");
            t.textContent = msg; t.className = "show";
            setTimeout(() => t.className = t.className.replace("show", ""), 3000);
        }

        window.onclick = function(e) { if (e.target.classList.contains('modal')) e.target.style.display = "none"; }
    </script>

    <div id="toast">Mensaje</div>

    <!-- MODAL CIERRE CAJA -->
    <div id="cash-close-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('cash-close-modal')">&times;</span>
            <h2>üìä Cierre de Caja</h2>
            <p style="color: #666; margin-bottom: 20px;">Resumen de ventas del d√≠a</p>
            <div style="background: #f3f4f6; padding: 20px; border-radius: 8px;">
                <h4>Total Recaudado Hoy</h4>
                <div style="font-size: 3rem; font-weight: bold; color: var(--success-color); margin: 10px 0;" id="cash-close-total">bs 0.00</div>
                <p id="cash-close-count">0 ventas realizadas</p>
            </div>
            <button class="btn btn-primary w-100 mt-2" onclick="confirmCashClose()">Aceptar</button>
        </div>
    </div>

    <!-- MODAL EDITAR PRODUCTO -->
    <div id="edit-product-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('edit-product-modal')">&times;</span>
            <h2 style="color: var(--accent-color);">‚úèÔ∏è Editar Producto</h2>
            <form id="edit-product-form" onsubmit="saveProductChanges(event)">
                <input type="hidden" id="edit-id">
                <div class="form-group"><label>Nombre</label><input type="text" id="edit-name" class="form-control" required></div>
                <div class="form-group"><label>Precio (bs)</label><input type="number" id="edit-price" class="form-control" min="0" step="0.01" required></div>
                <div class="form-group"><label>Sector</label><select id="edit-sector" class="form-control"><option value="1">Sector 1</option><option value="2">Sector 2</option><option value="3">Sector 3</option><option value="4">Sector 4</option><option value="Otro">Otro</option></select></div>
                <div style="display: flex; gap: 10px; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-danger w-100" onclick="closeModal('edit-product-modal')">Cancelar</button>
                    <button type="submit" class="btn btn-warning w-100">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- VISTA LOGIN (Solo Login) -->
    <section id="login-view">
        <div class="login-card">
            <h2>Minimercado üè™</h2>
            <form id="login-form">
                <div class="form-group"><label>Email</label><input type="email" id="username" class="form-control" placeholder="ejemplo@correo.com" required></div>
                <div class="form-group"><label>Contrase√±a</label><input type="password" id="password" class="form-control" placeholder="Ingrese contrase√±a" required></div>
                <button type="submit" class="btn btn-primary w-100">Ingresar</button>
            </form>
        </div>
    </section>

    <!-- APP PRINCIPAL -->
    <div id="main-app" class="hidden">
        <header>
            <h2>üè™ Minimercado</h2>
            <div class="user-info">
                Hola, <span id="user-display">Usuario</span> | 
                <button class="btn btn-danger" onclick="handleLogout()" style="padding: 5px 10px;">Salir</button>
            </div>
        </header>

        <main>
            <section id="admin-panel" class="hidden">
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchAdminTab('inventory')">Inventario</button>
                    <button class="tab-btn" onclick="switchAdminTab('reports')">Reportes</button>
                    <button class="tab-btn" onclick="switchAdminTab('users')">Usuarios</button>
                </div>

                <div id="admin-inventory-view">
                    <div class="admin-grid">
                        <div class="card">
                            <h3>Agregar Producto</h3>
                            <form id="add-product-form" onsubmit="addProduct(event)">
                                <div class="form-group"><label>Nombre</label><input type="text" id="prod-name" class="form-control" required></div>
                                <div class="form-group"><label>Precio (bs)</label><input type="number" id="prod-price" class="form-control" min="0" required></div>
                                <div class="form-group"><label>Stock</label><input type="number" id="prod-stock" class="form-control" min="0" required></div>
                                <div class="form-group"><label>Sector</label><select id="prod-sector" class="form-control"><option value="1">S1</option><option value="2">S2</option><option value="3">S3</option><option value="4">S4</option><option value="Otro">Otro</option></select></div>
                                <div class="form-group"><label>Imagen</label><input type="file" id="prod-image" class="form-control" accept="image/*"></div>
                                <button type="submit" class="btn btn-primary w-100">Guardar</button>
                            </form>
                        </div>
                        <div class="card">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <h3>Inventario</h3>
                                <span id="total-items-badge" class="sector-badge" style="background:#666">0 items</span>
                            </div>
                            <input type="text" id="search-inventory" class="form-control mt-2" placeholder="üîç Buscar..." onkeyup="renderAdminInventory()">
                            <div id="admin-inventory-list" class="inventory-grid"></div>
                        </div>
                    </div>
                </div>

                <div id="admin-reports-view" class="hidden">
                    <h3>üìä Reportes</h3>
                    <div class="stats-grid mt-2">
                        <div class="stat-card"><h4>Hoy</h4><div class="value" id="stat-today">bs 0.00</div></div>
                        <div class="stat-card success"><h4>Semana</h4><div class="value" id="stat-week">bs 0.00</div></div>
                        <div class="stat-card success"><h4>Mes</h4><div class="value" id="stat-month">bs 0.00</div></div>
                    </div>
                    <div class="card">
                        <h3>Registro</h3>
                        <div style="max-height: 400px; overflow-y: auto;">
                            <table class="history-table"><thead><tr><th>Fecha</th><th>Vendedor</th><th>Total</th></tr></thead><tbody id="full-sales-table"></tbody></table>
                        </div>
                    </div>
                </div>

                <div id="admin-users-view" class="hidden">
                    <div class="admin-grid">
                        <div class="card">
                            <h3>üîë Mi Cuenta</h3>
                            <div class="form-group"><label>Nueva Contrase√±a</label><input type="password" id="new-password-self" class="form-control"></div>
                            <button class="btn btn-primary w-100" onclick="updateSelfPassword()">Actualizar</button>
                        </div>
                        <div class="card">
                            <h3>üë• Crear Usuario</h3>
                            <p style="font-size:0.8rem; color:#666;">Registra nuevos vendedores o administradores aqu√≠.</p>
                            <form id="add-user-form" onsubmit="createUser(event)" style="display:flex; gap:10px; align-items:flex-end; margin-bottom: 1rem;">
                                <div style="flex-grow:1"><label>Email</label><input type="email" id="new-username" class="form-control" required></div>
                                <div style="flex-grow:1"><label>Pass</label><input type="text" id="new-userpass" class="form-control" required></div>
                                <div style="flex-grow:1"><label>Rol</label><select id="new-userrole" class="form-control"><option value="vendedor">Vendedor</option><option value="admin">Admin</option></select></div>
                                <button type="submit" class="btn btn-success">Crear</button>
                            </form>
                            <table class="history-table"><thead><tr><th>Email</th><th>Rol</th><th>Acci√≥n</th></tr></thead><tbody id="users-table-body"></tbody></table>
                        </div>
                    </div>
                </div>
            </section>

            <section id="seller-panel" class="hidden">
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchSellerTab('pos')">Punto de Venta</button>
                    <button class="tab-btn" onclick="switchSellerTab('history')">Historial</button>
                </div>

                <div id="seller-pos-view">
                    <div class="pos-container">
                        <div class="products-panel">
                            <input type="text" id="seller-search" class="form-control mb-2" placeholder="üîç Buscar..." onkeyup="renderSellerProducts()">
                            <div style="margin-bottom: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn btn-primary" onclick="filterSellerProducts('all')">Todos</button>
                                <button class="btn btn-primary" onclick="filterSellerProducts('1')">S1</button>
                                <button class="btn btn-primary" onclick="filterSellerProducts('2')">S2</button>
                                <button class="btn btn-primary" onclick="filterSellerProducts('3')">S3</button>
                            </div>
                            <div id="seller-products-grid" class="inventory-grid"></div>
                        </div>
                        <div class="cart-panel">
                            <h3>üõí Carrito</h3>
                            <div class="cart-items" id="cart-items-container"></div>
                            <div class="cart-total"><span>Total:</span><span id="cart-total-amount">bs 0.00</span></div>
                            <div class="form-group"><label>Efectivo:</label><input type="number" id="cash-given" class="form-control" oninput="calculateChange()"></div>
                            <div id="change-result" class="hidden"><div class="change-display">CAMBIO: <br><strong id="change-amount">bs 0.00</strong></div></div>
                            <button class="btn btn-success mt-2 w-100" onclick="processSale()">‚úÖ Vender</button>
                            <button class="btn btn-danger mt-2 w-100" onclick="clearCart()">üóëÔ∏è Cancelar</button>
                        </div>
                    </div>
                </div>

                <div id="seller-history-view" class="hidden">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3>üìú Historial</h3>
                        <button class="btn btn-success" onclick="openCashClose()">üí∞ Cierre</button>
                    </div>
                    <div class="card">
                        <table class="history-table"><thead><tr><th>Hora</th><th>Productos</th><th>Total</th></tr></thead><tbody id="today-sales-table"></tbody></table>
                    </div>
                </div>
            </section>
        </main>
    </div>
</body>
</html>
